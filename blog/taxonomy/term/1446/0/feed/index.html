<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xml:base="http://127.0.0.1:8080/blog"  xmlns:dc="http://purl.org/dc/elements/1.1/">
<channel>
 <title>Everything is a Freaking DNS problem - passenger</title>
 <link>http://127.0.0.1:8080/blog/taxonomy/term/1446/0</link>
 <description></description>
 <language>en</language>
<item>
 <title>24 hours of Puppet Drama</title>
 <link>http://127.0.0.1:8080/blog/24-hours-puppet-drama</link>
 <description>&lt;p&gt;Over the past couple of days I&#039;ve been fighting with a weird puppet problem , we eventually cracked it , but I promised a bunch of you to fully explain it here ;)&lt;/p&gt;
&lt;p&gt;So we were deploying 2 Blade chassis at a pretty remote location with a mix of phyisical and virtual machines, some 48 instances in total.    This is a pretty standard rollout, we&#039;ve got a bunch of similar platforms in our lab , so we knew about a couple of glitches, what to expect etc.&lt;/p&gt;
&lt;p&gt;I was just keeping an eye on the deployment,  looking at the logs seeing if things were running fine, when suddenly a couple of puppet runs didn&#039;t come trough,  we had seen such behaviour before,  usually it&#039;s a matter of running them a gain a couple of times and they will come trough.  (Upgrading ruby and putting passenger in front of puppet actually solved those issues,&lt;br /&gt;
We&#039;d even had a loop built in the platform that runs puppet a couple of times till it returns with the correct exit code just  to make sure. )&lt;/p&gt;
&lt;p&gt;We were first scratching the A chain of our setup, so that in the event of failure we could still bring up the B chain of the platform and be up and running again.   Actually machines were coming up.. slowly .. some of them took a bit longer .  One of the machine&#039;s clock was seriously off ..  the SSL was barfing on it  , so we set the bios clock, and restarted .. it was the machine with 6VM&#039;s   took a while but everything was back on schedule.. then suddenly things were going down fast  more and more puppetruns started failing and .. , at some point in time actually none of our puppet runs were working again .&lt;br /&gt;
I&#039;d see the puppetmaster perfectly compile it&#039;s catalog&lt;/p&gt;
&lt;p&gt;&lt;div class=&quot;geshifilter&quot;&gt;&lt;pre class=&quot;text geshifilter-text&quot; style=&quot;font-family:monospace;&quot;&gt;&lt;ol&gt;&lt;li style=&quot;font-family: monospace; font-weight: normal;&quot;&gt;&lt;div style=&quot;font-family: monospace; font-weight: normal; font-style: normal&quot;&gt;notice: Compiled catalog for ctl-0-a&lt;/div&gt;&lt;/li&gt;&lt;/ol&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/p&gt;
&lt;p&gt;Then the client .. not wanting to get it ..&lt;/p&gt;
&lt;p&gt;&lt;div class=&quot;geshifilter&quot;&gt;&lt;pre class=&quot;text geshifilter-text&quot; style=&quot;font-family:monospace;&quot;&gt;&lt;ol&gt;&lt;li style=&quot;font-family: monospace; font-weight: normal;&quot;&gt;&lt;div style=&quot;font-family: monospace; font-weight: normal; font-style: normal&quot;&gt;Mar  1 11:10:45 ctl-0-a puppet-agent[3674]: Not using expired catalog for ctl-0-a from cache; expired at Tue Mar 01 09:50:06 +0000 2011&lt;/div&gt;&lt;/li&gt;&lt;li style=&quot;font-family: monospace; font-weight: normal;&quot;&gt;&lt;div style=&quot;font-family: monospace; font-weight: normal; font-style: normal&quot;&gt;Mar  1 11:10:45 ctl-0-a puppet-agent[3674]: Using cached catalog&lt;/div&gt;&lt;/li&gt;&lt;li style=&quot;font-family: monospace; font-weight: normal;&quot;&gt;&lt;div style=&quot;font-family: monospace; font-weight: normal; font-style: normal&quot;&gt;Mar  1 11:10:45 ctl-0-a puppet-agent[3674]: Could not retrieve catalog; skipping run&lt;/div&gt;&lt;/li&gt;&lt;/ol&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/p&gt;
&lt;p&gt;We had gone from about 60% of our fresly deployed boxen working fine,  to not one&lt;br /&gt;
So what do you do .. indeed .. you turn on debugging.&lt;br /&gt;
You put both your puppetmaster and client in debug.   Nothing, no errors no nothing ..&lt;/p&gt;
&lt;p&gt;I asked some collegues, asked on irc .. much ideas but none of them that actually cracked the problem.  I did what I knew that solve similar problems before,&lt;/p&gt;
&lt;p&gt;I switched our serialization format from yaml back to pson , and back, no luck.&lt;br /&gt;
I upgraded ruby to a version from the  &lt;a href=&quot;http://yum.glei.ch/&quot; rel=&quot;nofollow&quot;&gt;glei.ch&lt;/a&gt; repository.    No luck.&lt;br /&gt;
I upgraded our Puppet version  2.6  to a version from &lt;a href=&quot;http://tmz.fedorapeople.org/repo/puppet/epel/5/i386/&quot; rel=&quot;nofollow&quot;&gt;the TMZ Epel repo&lt;/a&gt; , we cleaned out ssl the certificates on all sides  multiple times. Cleaned out  /var/lib/puppet  ,  We uninstalled puppet and reinstalled it.&lt;br /&gt;
It wasn&#039;t a DNS Problem&lt;/p&gt;
&lt;p&gt;I had started stripping my manifests to empty runs, those worked,  then started uncommenting the actual manifests again ...  Then in the middle of the debug our VPN connection to the remote location broke down,  we&#039;d only be getting it back in the morning ..about 12 hours later not fun.  Murphy obviously ..&lt;/p&gt;
&lt;p&gt;So the next morning we dived right back in ... making those manifests bigger again,  removing all the stages,  1 or 2 successful runs, then with the same config .. back to failure.   On and off.. successfull and unscussessful.  ... it wasn&#039;t in the manifests ..&lt;/p&gt;
&lt;p&gt;So we decided to roll the puppetmaster back to it&#039;s previous version, that one was known to be stable, there obviously was something really fishy going, so that was the safest bet.&lt;/p&gt;
&lt;p&gt;Wrong,  the machine came up, but it took longer than expected,  and when trying to connect new clients to it .. nothing worked anymore .. same problem as before .. puppetmaster compiles catalog,  clients didn&#039;t get anything.    we started to suspect faulty hardware .. but how could that bee.. the puppetclient looked liked the only malfunctioning thing around .&lt;/p&gt;
&lt;p&gt;Then &lt;a href=&quot;http://twitter.com/#!/dim0&quot; rel=&quot;nofollow&quot;&gt;Dim0&lt;/a&gt; suggested me to look at the that one logfile I hadn&#039;t looked , /var/log/puppet/masterhttp.log    and then we saw it .  it was being flooded with ssl errors,   ssl errors from clients that shouldn&#039;t even be connecting to the puppetmaster at all.&lt;/p&gt;
&lt;p&gt;&lt;div class=&quot;geshifilter&quot;&gt;&lt;pre class=&quot;text geshifilter-text&quot; style=&quot;font-family:monospace;&quot;&gt;&lt;ol&gt;&lt;li style=&quot;font-family: monospace; font-weight: normal;&quot;&gt;&lt;div style=&quot;font-family: monospace; font-weight: normal; font-style: normal&quot;&gt;[2011-03-02 13:32:00] ERROR OpenSSL::SSL::SSLError: tlsv1 alert decrypt error&lt;/div&gt;&lt;/li&gt;&lt;li style=&quot;font-family: monospace; font-weight: normal;&quot;&gt;&lt;div style=&quot;font-family: monospace; font-weight: normal; font-style: normal&quot;&gt;        /usr/lib/ruby/site_ruby/1.8/puppet/network/http/webrick.rb:44:in `accept&#039;&lt;/div&gt;&lt;/li&gt;&lt;li style=&quot;font-family: monospace; font-weight: normal;&quot;&gt;&lt;div style=&quot;font-family: monospace; font-weight: normal; font-style: normal&quot;&gt;        /usr/lib/ruby/site_ruby/1.8/puppet/network/http/webrick.rb:44:in `listen&#039;&lt;/div&gt;&lt;/li&gt;&lt;li style=&quot;font-family: monospace; font-weight: normal;&quot;&gt;&lt;div style=&quot;font-family: monospace; font-weight: normal; font-style: normal&quot;&gt;        /usr/lib/ruby/1.8/webrick/server.rb:173:in `call&#039;&lt;/div&gt;&lt;/li&gt;&lt;li style=&quot;font-family: monospace; font-weight: normal;&quot;&gt;&lt;div style=&quot;font-family: monospace; font-weight: normal; font-style: normal&quot;&gt;        /usr/lib/ruby/1.8/webrick/server.rb:173:in `start_thread&#039;&lt;/div&gt;&lt;/li&gt;&lt;li style=&quot;font-family: monospace; font-weight: normal;&quot;&gt;&lt;div style=&quot;font-family: monospace; font-weight: normal; font-style: normal&quot;&gt;        /usr/lib/ruby/1.8/webrick/server.rb:162:in `start&#039;&lt;/div&gt;&lt;/li&gt;&lt;li style=&quot;font-family: monospace; font-weight: normal;&quot;&gt;&lt;div style=&quot;font-family: monospace; font-weight: normal; font-style: normal&quot;&gt;        /usr/lib/ruby/1.8/webrick/server.rb:162:in `start_thread&#039;&lt;/div&gt;&lt;/li&gt;&lt;li style=&quot;font-family: monospace; font-weight: normal;&quot;&gt;&lt;div style=&quot;font-family: monospace; font-weight: normal; font-style: normal&quot;&gt;        /usr/lib/ruby/1.8/webrick/server.rb:95:in `start&#039;&lt;/div&gt;&lt;/li&gt;&lt;li style=&quot;font-family: monospace; font-weight: normal;&quot;&gt;&lt;div style=&quot;font-family: monospace; font-weight: normal; font-style: normal&quot;&gt;        /usr/lib/ruby/1.8/webrick/server.rb:92:in `each&#039;&lt;/div&gt;&lt;/li&gt;&lt;li style=&quot;font-family: monospace; font-weight: normal;&quot;&gt;&lt;div style=&quot;font-family: monospace; font-weight: normal; font-style: normal&quot;&gt;        /usr/lib/ruby/1.8/webrick/server.rb:92:in `start&#039;&lt;/div&gt;&lt;/li&gt;&lt;li style=&quot;font-family: monospace; font-weight: normal;&quot;&gt;&lt;div style=&quot;font-family: monospace; font-weight: normal; font-style: normal&quot;&gt;        /usr/lib/ruby/1.8/webrick/server.rb:23:in `start&#039;&lt;/div&gt;&lt;/li&gt;&lt;li style=&quot;font-family: monospace; font-weight: normal;&quot;&gt;&lt;div style=&quot;font-family: monospace; font-weight: normal; font-style: normal&quot;&gt;        /usr/lib/ruby/1.8/webrick/server.rb:82:in `start&#039;&lt;/div&gt;&lt;/li&gt;&lt;li style=&quot;font-family: monospace; font-weight: normal;&quot;&gt;&lt;div style=&quot;font-family: monospace; font-weight: normal; font-style: normal&quot;&gt;        /usr/lib/ruby/site_ruby/1.8/puppet/network/http/webrick.rb:42:in `listen&#039;&lt;/div&gt;&lt;/li&gt;&lt;li style=&quot;font-family: monospace; font-weight: normal;&quot;&gt;&lt;div style=&quot;font-family: monospace; font-weight: normal; font-style: normal&quot;&gt;        /usr/lib/ruby/site_ruby/1.8/puppet/network/http/webrick.rb:41:in `initialize&#039;&lt;/div&gt;&lt;/li&gt;&lt;li style=&quot;font-family: monospace; font-weight: normal;&quot;&gt;&lt;div style=&quot;font-family: monospace; font-weight: normal; font-style: normal&quot;&gt;        /usr/lib/ruby/site_ruby/1.8/puppet/network/http/webrick.rb:41:in `new&#039;&lt;/div&gt;&lt;/li&gt;&lt;li style=&quot;font-family: monospace; font-weight: normal;&quot;&gt;&lt;div style=&quot;font-family: monospace; font-weight: normal; font-style: normal&quot;&gt;        /usr/lib/ruby/site_ruby/1.8/puppet/network/http/webrick.rb:41:in `listen&#039;&lt;/div&gt;&lt;/li&gt;&lt;li style=&quot;font-family: monospace; font-weight: normal;&quot;&gt;&lt;div style=&quot;font-family: monospace; font-weight: normal; font-style: normal&quot;&gt;        /usr/lib/ruby/1.8/thread.rb:135:in `synchronize&#039;&lt;/div&gt;&lt;/li&gt;&lt;li style=&quot;font-family: monospace; font-weight: normal;&quot;&gt;&lt;div style=&quot;font-family: monospace; font-weight: normal; font-style: normal&quot;&gt;        /usr/lib/ruby/site_ruby/1.8/puppet/network/http/webrick.rb:38:in `listen&#039;&lt;/div&gt;&lt;/li&gt;&lt;li style=&quot;font-family: monospace; font-weight: normal;&quot;&gt;&lt;div style=&quot;font-family: monospace; font-weight: normal; font-style: normal&quot;&gt;        /usr/lib/ruby/site_ruby/1.8/puppet/network/server.rb:127:in `listen&#039;&lt;/div&gt;&lt;/li&gt;&lt;li style=&quot;font-family: monospace; font-weight: normal;&quot;&gt;&lt;div style=&quot;font-family: monospace; font-weight: normal; font-style: normal&quot;&gt;        /usr/lib/ruby/site_ruby/1.8/puppet/network/server.rb:142:in `start&#039;&lt;/div&gt;&lt;/li&gt;&lt;li style=&quot;font-family: monospace; font-weight: normal;&quot;&gt;&lt;div style=&quot;font-family: monospace; font-weight: normal; font-style: normal&quot;&gt;        /usr/lib/ruby/site_ruby/1.8/puppet/daemon.rb:124:in `start&#039;&lt;/div&gt;&lt;/li&gt;&lt;li style=&quot;font-family: monospace; font-weight: normal;&quot;&gt;&lt;div style=&quot;font-family: monospace; font-weight: normal; font-style: normal&quot;&gt;        /usr/lib/ruby/site_ruby/1.8/puppet/application/master.rb:114:in `main&#039;&lt;/div&gt;&lt;/li&gt;&lt;li style=&quot;font-family: monospace; font-weight: normal;&quot;&gt;&lt;div style=&quot;font-family: monospace; font-weight: normal; font-style: normal&quot;&gt;        /usr/lib/ruby/site_ruby/1.8/puppet/application/master.rb:46:in `run_command&#039;&lt;/div&gt;&lt;/li&gt;&lt;li style=&quot;font-family: monospace; font-weight: normal;&quot;&gt;&lt;div style=&quot;font-family: monospace; font-weight: normal; font-style: normal&quot;&gt;        /usr/lib/ruby/site_ruby/1.8/puppet/application.rb:287:in `run&#039;&lt;/div&gt;&lt;/li&gt;&lt;li style=&quot;font-family: monospace; font-weight: normal;&quot;&gt;&lt;div style=&quot;font-family: monospace; font-weight: normal; font-style: normal&quot;&gt;        /usr/lib/ruby/site_ruby/1.8/puppet/application.rb:393:in `exit_on_fail&#039;&lt;/div&gt;&lt;/li&gt;&lt;li style=&quot;font-family: monospace; font-weight: normal;&quot;&gt;&lt;div style=&quot;font-family: monospace; font-weight: normal; font-style: normal&quot;&gt;        /usr/lib/ruby/site_ruby/1.8/puppet/application.rb:287:in `run&#039;&lt;/div&gt;&lt;/li&gt;&lt;li style=&quot;font-family: monospace; font-weight: normal;&quot;&gt;&lt;div style=&quot;font-family: monospace; font-weight: normal; font-style: normal&quot;&gt;        /usr/sbin/puppetmasterd:4&lt;/div&gt;&lt;/li&gt;&lt;li style=&quot;font-family: monospace; font-weight: normal;&quot;&gt;&lt;div style=&quot;font-family: monospace; font-weight: normal; font-style: normal&quot;&gt;[2011-03-02 13:32:00] ERROR OpenSSL::SSL::SSLError: tlsv1 alert decrypt error&lt;/div&gt;&lt;/li&gt;&lt;/ol&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/p&gt;
&lt;p&gt;What happened was that  &#039;we&#039; decided to bring of the  one backup machines back online, afterall once the slow starting server  came trough, it would be the passive node in the cluster , no worries there, right ?   Wrong,&lt;br /&gt;
This physical machine had 6 virtual machines with old ssl certificates that got stuck in an  loop which was put there to sure their puppetrun came trough correctly at boot time.&lt;/p&gt;
&lt;p&gt;Those 7 rogue clients which generated little to no relevant traffic on the network were saturating the default webrick,   killing them solved the problem and we were back to regular deployment in no time.&lt;/p&gt;
&lt;p&gt;The sad part is that our upcoming release already has passenger , a fresher version of ruby etc .. and that most of the above mentioned errors won&#039;t occur anymore there.&lt;br /&gt;
But in short .. don&#039;t use the default webrick .. it will kill you :)&lt;/p&gt;
&lt;p&gt;And no , not everything is a freaking dns problem, ssl is a big pain in the B too ..  :)&lt;/p&gt;
</description>
 <comments>http://127.0.0.1:8080/blog/24-hours-puppet-drama#comments</comments>
 <category domain="http://127.0.0.1:8080/blog/category/devops">devops</category>
 <category domain="http://127.0.0.1:8080/blog/category/passenger">passenger</category>
 <category domain="http://127.0.0.1:8080/blog/taxonomy/term/439">puppet</category>
 <category domain="http://127.0.0.1:8080/blog/taxonomy/term/441">ruby</category>
 <category domain="http://127.0.0.1:8080/blog/category/ssl">ssl</category>
 <category domain="http://127.0.0.1:8080/blog/category/webrick">webrick</category>
 <pubDate>Thu, 03 Mar 2011 23:42:45 +0000</pubDate>
 <dc:creator>Kris Buytaert</dc:creator>
 <guid isPermaLink="false">1037 at http://127.0.0.1:8080/blog</guid>
</item>
</channel>
</rss>
