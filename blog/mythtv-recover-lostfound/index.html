<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">

<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>MythTV recover Lost+Found  | Everything is a Freaking DNS problem</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../misc/favicon/index.ico" type="image/x-icon" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/aggregator/aggregator/index.css?i" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/node/node/index.css?i" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/poll/poll/index.css?i" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults/index.css?i" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system/index.css?i" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus/index.css?i" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user/index.css?i" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/cck/theme/content-module/index.css?i" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/date/date/index.css?i" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/geshifilter/geshifilter/index.css?i" />
<link type="text/css" rel="stylesheet" media="all" href="../misc/farbtastic/farbtastic/index.css?i" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/calendar/calendar/index.css?i" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/cck/modules/fieldgroup/fieldgroup/index.css?i" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views/index.css?i" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment/index.css?i" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/default/themes/barlow/typography/index.css?i" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/default/themes/barlow/layout/index.css?i" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/default/themes/barlow/style/index.css?i" />
<link type="text/css" rel="stylesheet" media="print" href="../sites/default/themes/barlow/print/index.css?i" />
</head>

<body class="not-front not-logged-in page-node node-type-blog one-sidebar sidebar-left">
<div id="wrapper">

<div id="header" class="p1">

  <div id="branding">
      <div id="logo">
    <a href="../index/index.html" title="Everything is a Freaking DNS problem" rel="home">
    <img src="../files/me_small/index.jpg" alt="Everything is a Freaking DNS problem" id="logo-image" />
    </a></div>
        <h1><a href="../index/index.html" title="Home" rel="home">Everything is a Freaking DNS problem</a></h1>
        <div class="slogan">Devops Needs Sushi</div>
    </div>

  
  <div class="skip"><a href="#content" title="Skip to site content" accesskey="2">Skip to content</a></div>

  
  <div id="menu">
      </div>
</div>

<div id="content">

  <div id="sidebar-left" class="sidebar">
  <div class="block block-block" id="block-block-5">
  <div class="content"><p>This is the blog where <a href="http://www.krisbuytaert.be/bio.shtml">Kris Buytaert</a> points you to extremely interresting and totally irrelevant stuff that happens in Life , The Universe and Everything</p>
<p>Questions, want to contact me please read my <a href="../faq/index/index.html">FAQ</a> and  <a href="../social/index/index.html">Social Media Policy</a></p>
<p>You can hire me! I work as a consultant for <a href="http://www.inuits.eu/">Inuits.eu</a></p>
<p><a href="../rss/index.xml">Feed</a></p>
</div>
</div>

  </div>

<div id="main">
  <div id="breadcrumb"><div class="breadcrumb"><a href="../index/index.html">Home</a> &#8594; <a href="../blog/index.html">Blogs</a> &#8594; <a href="../blogs/kris-buytaert/index.html">Kris Buytaert&#039;s blog</a></div></div>
  <h2 id="title">MythTV recover Lost+Found </h2>
<div class="content">
<div id="node-843" class="node  blog">
<div class="content"><p>My MythTV store lives on an LVM volume that is spread over 2 disks, one of them is an external USB disk.   So the cleaninglady seems to have touched a cable and after coming back from holiday I had a read-only filesystem that afer a remount had about 350Gb in lost+found   with irrelevant filenames.</p>
<p><div class="geshifilter"><pre class="text geshifilter-text" style="font-family:monospace;"><ol><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">total 337407844</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">drwx------   2 tv   tv         4096 Dec 17 22:47 .</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">drwxrwxrwx  15 tv   tv         4096 Dec 17 22:44 ..</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">-rw-r--r--   1 root root  423343556 Dec 14 07:10 I303109.RCN</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">-rw-r--r--   1 root root 2990538924 Dec 13 19:05 I303107.RCN</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">-rw-r--r--   1 root root 1023691768 Dec 13 08:10 I319494.RCN</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">-rw-r--r--   1 root root 1023622348 Dec 13 07:45 I327684.RCN</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">-rw-r--r--   1 root root  423735892 Dec 13 07:10 I327682.RCN</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">-rw-r--r--   1 root root  466749476 Dec 12 15:43 I135169.RCN</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">-rw-r--r--   1 root root 1023314212 Dec 12 07:45 I098309.RCN</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">-rw-r--r--   1 root root 1022459928 Dec 12 06:35 I098306.RCN</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">-rw-r--r--   1 root root 2458822948 Dec  9 22:50 I139264.RCN</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">-rw-r--r--   1 root root 2129683736 Dec  9 21:30 I323592.RCN</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">-rw-r--r--   1 root root  466735992 Dec  9 15:43 I323590.RCN</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">-rw-r--r--   1 root root 1022747296 Dec  9 07:45 I323588.RCN</div></li></ol></pre></div></p>
<p>Obviously I wanted to recover my data.<br />
So I had files with a wrong filename on a filesystem but with a correct timestamp and probably the right filesize.<br />
Luckily the  mythconverg.recorded table also gives  me lots of information about the files that mythtv had originally stored the content in.</p>
<p><div class="geshifilter"><pre class="text geshifilter-text" style="font-family:monospace;"><ol><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">mysql&gt; select basename,lastmodified,filesize from recorded limit 10;</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">+---------------------------+---------------------+------------+</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">| basename                  | lastmodified        | filesize   |</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">+---------------------------+---------------------+------------+</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">| 1003_20081003230000.mpg   | 2008-10-07 21:53:49 | 6197765380 |</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">| 1093_20080320232600.mpg   | 2008-03-20 23:25:31 |          0 |</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">| 1075_20060301191300.mpg   | 2006-03-24 22:48:42 |          0 |</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">| 1002_20080729160500.mpg   | 2008-07-29 19:20:30 | 3679223940 |</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">| 592251_20081217072000.mpg | 2008-12-17 07:20:02 |          0 |</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">| 1002_20080911143500.mpg   | 2008-09-11 16:41:44 | 3486101572 |</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">| 1002_20080923143500.mpg   | 2008-09-23 16:49:41 | 3679789684 |</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">| 1033_20081110153500.mpg   | 2008-11-10 15:47:12 |  338877000 |</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">| 1002_20080922144000.mpg   | 2008-09-22 16:47:38 | 3485505140 |</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">| 1002_20080721160500.mpg   | 2008-07-23 20:52:16 | 3679559444 |</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">+---------------------------+---------------------+------------+</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">10 rows in set (0.00 sec)</div></li></ol></pre></div></p>
<p>My first idea was to use  <a href="http://code.google.com/p/mysql-filesystem-engine/" rel="nofollow">the mysql filesystem engine</a> to query the filesytem and write me a simple query however I totally failed to build that engine :(<br />
(Anyone else successfull here ? )</p>
<p>So I created a temp table</p>
<p><div class="geshifilter"><pre class="text geshifilter-text" style="font-family:monospace;"><ol><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">CREATE TABLE `temp2` (</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">  `size` bigint(20) default NULL,</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">  `oldname` varchar(255) default NULL,</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">  `lastmod` timestamp NOT NULL default CURRENT_TIMESTAMP on update CURRENT_TIMESTAMP</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">) ENGINE=MyISAM DEFAULT CHARSET=latin1</div></li></ol></pre></div></p>
<p>And parsed the content of my lost+found directory into a set of insert statements<br />
<div class="geshifilter"><pre class="text geshifilter-text" style="font-family:monospace;"><ol><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">ls -l --time-style=long-iso | awk  -F' ' '{print &quot;insert into temp2 values (&quot;  $5 &quot;,\&quot;&quot;  $8&quot;\&quot;,\&quot;&quot;$6&quot; &quot;$7&quot;\&quot;);&quot;}'</div></li></ol></pre></div></p>
<p>From there is a matter of grabbing the matching filenames</p>
<p><div class="geshifilter"><pre class="text geshifilter-text" style="font-family:monospace;"><ol><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">echo &quot;select \&quot;mv \&quot; , oldname, basename from recorded, temp2 where temp2.size= recorded.filesize ;&quot; | mysql mythconverg</div></li></ol></pre></div></p>
<p>And moving the actual files ... now all is back to normal ..</p>
</div>
  <div class="meta">
   <div class="submitted">Submitted by Kris Buytaert on Fri, 12/19/2008 - 20:41</div>
     <div class="taxonomy">Tags: <ul class="links inline"><li class="taxonomy_term_1131 first"><a href="../category/crash/index.html" rel="tag" title="">crash</a></li>
<li class="taxonomy_term_1129"><a href="../category/lostfound/index.html" rel="tag" title="">lost+found</a></li>
<li class="taxonomy_term_458"><a href="../taxonomy/term/458/index.html" rel="tag" title="">mysql</a></li>
<li class="taxonomy_term_504"><a href="../taxonomy/term/504/index.html" rel="tag" title="">mythtv</a></li>
<li class="taxonomy_term_599"><a href="../taxonomy/term/599/index.html" rel="tag" title="">opensource</a></li>
<li class="taxonomy_term_1130"><a href="../category/recovery/index.html" rel="tag" title="">recovery</a></li>
<li class="taxonomy_term_1132 last"><a href="../category/scripting/index.html" rel="tag" title="">scripting</a></li>
</ul></div>
     <div class="links">&raquo; <ul class="links inline"><li class="blog_usernames_blog first last"><a href="../blogs/kris-buytaert/index.html" title="Read Kris Buytaert&#039;s latest blog entries.">Kris Buytaert&#039;s blog</a></li>
</ul></div>
  </div>
</div>
<div id="comments">
  <h2>Comments</h2>
  <a id="comment-3419"></a>
<div id="comment-1" class="comment comment-by-anonymous clear-block">
  <div class="picture">
  <a href="http://www.telegraphics.com.au/sw/" title="View user website." rel="external nofollow"><img src="http://www.gravatar.com/avatar/fd09b8b7c5ad0d2a0bba02ef44a6ac16.jpg?d=http%3A%2F%2F127.0.0.1%3A8080%2Fblog%2Fsites%2Fall%2Fmodules%2Fgravatar%2Favatar.png&amp;s=85&amp;r=G" alt="Toby&#039;s picture" title="Toby&#039;s picture"  /></a></div>
<h3>
    <a class="id" href="#comment-3419">#1</a>
    <span class="author"><a href="http://www.telegraphics.com.au/sw/">Toby</a></span>  : <span class="title"><a href="index.html#comment-3419" class="active">Time to start running ZFS</a></span>
  </h3>
  <div class="content"><p>The conventional filesystem design is showing its age.</p>
</div>
        <br class="clear" />
    <div class="submitted">12/20/2008 - 04:00</div>
  </div>
</div>
</div>
</div>

</div>

<div id="footer" class="footer">
  No really .. everything is a funky DNS problem , you'll realise I`m right pretty soon !   
  <p class="credits">Powered by <a href="http://www.drupal.org/">Drupal</a> and the <a href="http://www.drupal.org/project/barlow">Barlow</a> theme by <a href="http://egonbianchet.net/">Egon Bianchet</a>.</p>
</div>

</div>

</body>
</html>
