<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">

<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>DRBD2, OCFS2,  Unexplained crashes | Everything is a Freaking DNS problem</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../misc/favicon/index.ico" type="image/x-icon" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/aggregator/aggregator/index.css?i" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/node/node/index.css?i" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/poll/poll/index.css?i" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults/index.css?i" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system/index.css?i" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus/index.css?i" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user/index.css?i" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/cck/theme/content-module/index.css?i" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/date/date/index.css?i" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/geshifilter/geshifilter/index.css?i" />
<link type="text/css" rel="stylesheet" media="all" href="../misc/farbtastic/farbtastic/index.css?i" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/calendar/calendar/index.css?i" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/cck/modules/fieldgroup/fieldgroup/index.css?i" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views/index.css?i" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment/index.css?i" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/default/themes/barlow/typography/index.css?i" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/default/themes/barlow/layout/index.css?i" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/default/themes/barlow/style/index.css?i" />
<link type="text/css" rel="stylesheet" media="print" href="../sites/default/themes/barlow/print/index.css?i" />
</head>

<body class="not-front not-logged-in page-node node-type-blog one-sidebar sidebar-left">
<div id="wrapper">

<div id="header" class="p1">

  <div id="branding">
      <div id="logo">
    <a href="../index/index.html" title="Everything is a Freaking DNS problem" rel="home">
    <img src="../files/me_small/index.jpg" alt="Everything is a Freaking DNS problem" id="logo-image" />
    </a></div>
        <h1><a href="../index/index.html" title="Home" rel="home">Everything is a Freaking DNS problem</a></h1>
        <div class="slogan">Devops Needs Sushi</div>
    </div>

  
  <div class="skip"><a href="#content" title="Skip to site content" accesskey="2">Skip to content</a></div>

  
  <div id="menu">
      </div>
</div>

<div id="content">

  <div id="sidebar-left" class="sidebar">
  <div class="block block-block" id="block-block-5">
  <div class="content"><p>This is the blog where <a href="http://www.krisbuytaert.be/bio.shtml">Kris Buytaert</a> points you to extremely interresting and totally irrelevant stuff that happens in Life , The Universe and Everything</p>
<p>Questions, want to contact me please read my <a href="../faq/index/index.html">FAQ</a> and  <a href="../social/index/index.html">Social Media Policy</a></p>
<p>You can hire me! I work as a consultant for <a href="http://www.inuits.eu/">Inuits.eu</a></p>
<p><a href="../rss/index.xml">Feed</a></p>
</div>
</div>

  </div>

<div id="main">
  <div id="breadcrumb"><div class="breadcrumb"><a href="../index/index.html">Home</a> &#8594; <a href="../blog/index.html">Blogs</a> &#8594; <a href="../blogs/kris-buytaert/index.html">Kris Buytaert&#039;s blog</a></div></div>
  <h2 id="title">DRBD2, OCFS2,  Unexplained crashes</h2>
<div class="content">
<div id="node-922" class="node  blog">
<div class="content"><p>I was trying to setup a dual-primary DRBD environment, with a shared disk with either OCFS2 or GFS.   The environment is a Centos 5.3 with DRBD82 (but also tried with DRBD83 from testing) .</p>
<p>Setting up a single primary disk and running bonnie++ on it worked Setting up a dual-primary disk, only mounting it on one node (ext3) and running bonnie++  worked</p>
<p>When setting up ocfs2 on the /dev/drbd0 disk and mounting it on both nodes, basic functionality seemed in place but usually less than 5-10 minutes after I start bonnie++ as a test on one of the nodes , both nodes power cycle  with no errors in the logfiles, just a crash.</p>
<p>When at the console at the time of crash it looks like a disk IO (you can type , but actions happen)  block happens  then a reboot, no panics, no oops , nothing. ( sysctl panic values set to timeouts etc )<br />
Setting up a dual-primary disk , with ocfs2 only mounting it on one node and starting bonnie++ causes only that node to crash.</p>
<p>On DRBD level I got the following error when that node disappears<br />
<div class="geshifilter"><pre class="text geshifilter-text" style="font-family:monospace;"><ol><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">drbd0: PingAck did not arrive in time.</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">drbd0: peer( Primary -&gt; Unknown ) conn( Connected -&gt; NetworkFailure )</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">pdsk(UpToDate -&gt; DUnknown )</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">drbd0: asender terminated</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">drbd0: Terminating asender thread</div></li></ol></pre></div><br />
That however is an expected error because of the reboot.</p>
<p>At first I assumed OCFS2 to be the root of this problem ..so I moved forward and setup an ISCSI target on a 3rd node, and used that device with the same OCFS2 setup. There no crashes occured and bonnie++ flawlessly completed it test run. </p>
<p>So my attention went  back to the combination of DRBD and OCFS<br />
I tried both DRBD 8.2 drbd82-8.2.6-1.el5.centos kmod-drbd82-8.2.6-2  and the 83 variant from Centos Testing</p>
<p>At first I was trying with the ocfs2 1.4.1-1.el5.i386.rpm verson but upgrading to  1.4.2-1.el5.i386.rpm didn't change the behaviour </p>
<p>Both the DRBD as the OCFS mailinglist were fairly supportive pointing me out that it was probably OCFS2 fencing both hosts after missing the heartbeat, and suggested increasing the deathtimetimeout values.</p>
<p>I however wanted to confirm that. As I got no entries in syslog I attached a Cyclades err Avocent Terminal server to the device in the hope that I'd capture the last kernel messsages there ...   no such luck either.</p>
<p>On the OCFS2 mailinlist people pointed out that i'd use netconsole to catch the logs on a remote node<br />
I set up netconsole using</p>
<p><div class="geshifilter"><pre class="text geshifilter-text" style="font-family:monospace;"><ol><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">modprobe  netconsole netconsole=&quot;@/,@172.16.32.1/&quot;</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">sysctl -w kernel.printk=&quot;7 4 1 7&quot;</div></li></ol></pre></div></p>
<p>After which indeed I catched error on my remote host..<br />
<div class="geshifilter"><pre class="text geshifilter-text" style="font-family:monospace;"><ol><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">[base-root@CCMT-A ~]# nc -l -u -p 6666</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">(8,0):o2hb_write_timeout:166 ERROR: Heartbeat write timeout to device</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">drbd0 after 478000 milliseconds</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">(8,0):o2hb_stop_all_regions:1873 ERROR: stopping heartbeat on all active</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">regions.</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">ocfs2 is very sorry to be fencing this system by restarting</div></li></ol></pre></div></p>
<p>One'd think that it output over Serial console before it log over the network :)   It doesn't .</p>
<p>Next step is that I`ll start fiddling some more with the timeout values :)  (note the ":)")</p>
</div>
  <div class="meta">
   <div class="submitted">Submitted by Kris Buytaert on Wed, 07/01/2009 - 16:01</div>
     <div class="taxonomy">Tags: <ul class="links inline"><li class="taxonomy_term_899 first"><a href="../taxonomy/term/899/index.html" rel="tag" title="">drbd</a></li>
<li class="taxonomy_term_434"><a href="../taxonomy/term/434/index.html" rel="tag" title="">gfs</a></li>
<li class="taxonomy_term_449"><a href="../taxonomy/term/449/index.html" rel="tag" title="">ha</a></li>
<li class="taxonomy_term_1268"><a href="../category/iscsi/index.html" rel="tag" title="">iscsi</a></li>
<li class="taxonomy_term_1269"><a href="../category/netconsole/index.html" rel="tag" title="">netconsole</a></li>
<li class="taxonomy_term_1267 last"><a href="../category/ocfs2/index.html" rel="tag" title="">ocfs2</a></li>
</ul></div>
     <div class="links">&raquo; <ul class="links inline"><li class="blog_usernames_blog first last"><a href="../blogs/kris-buytaert/index.html" title="Read Kris Buytaert&#039;s latest blog entries.">Kris Buytaert&#039;s blog</a></li>
</ul></div>
  </div>
</div>
</div>
</div>

</div>

<div id="footer" class="footer">
  No really .. everything is a funky DNS problem , you'll realise I`m right pretty soon !   
  <p class="credits">Powered by <a href="http://www.drupal.org/">Drupal</a> and the <a href="http://www.drupal.org/project/barlow">Barlow</a> theme by <a href="http://egonbianchet.net/">Egon Bianchet</a>.</p>
</div>

</div>

</body>
</html>
