<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">


<!-- Mirrored from 127.0.0.1:8080/blog/4158-second-catalog-run by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 01 Sep 2017 19:44:48 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>The 4158 second catalog run. | Everything is a Freaking DNS problem</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../misc/favicon/index.ico" type="image/x-icon" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/aggregator/aggregator/index.css?9" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/node/node/index.css?9" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/poll/poll/index.css?9" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults/index.css?9" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system/index.css?9" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus/index.css?9" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user/index.css?9" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/cck/theme/content-module/index.css?9" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/date/date/index.css?9" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/geshifilter/geshifilter/index.css?9" />
<link type="text/css" rel="stylesheet" media="all" href="../misc/farbtastic/farbtastic/index.css?9" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/calendar/calendar/index.css?9" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/cck/modules/fieldgroup/fieldgroup/index.css?9" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views/index.css?9" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment/index.css?9" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/default/themes/barlow/typography/index.css?9" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/default/themes/barlow/layout/index.css?9" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/default/themes/barlow/style/index.css?9" />
<link type="text/css" rel="stylesheet" media="print" href="../sites/default/themes/barlow/print/index.css?9" />
</head>

<body class="not-front not-logged-in page-node node-type-blog one-sidebar sidebar-left">
<div id="wrapper">

<div id="header" class="p1">

  <div id="branding">
      <div id="logo">
    <a href="../index/index.html" title="Everything is a Freaking DNS problem" rel="home">
    <img src="../files/me_small/index.jpg" alt="Everything is a Freaking DNS problem" id="logo-image" />
    </a></div>
        <h1><a href="../index/index.html" title="Home" rel="home">Everything is a Freaking DNS problem</a></h1>
        <div class="slogan">Devops Needs Sushi</div>
    </div>

  
  <div class="skip"><a href="#content" title="Skip to site content" accesskey="2">Skip to content</a></div>

  
  <div id="menu">
      </div>
</div>

<div id="content">

  <div id="sidebar-left" class="sidebar">
  <div class="block block-block" id="block-block-5">
  <div class="content"><p>This is the blog where <a href="http://www.krisbuytaert.be/bio.shtml">Kris Buytaert</a> points you to extremely interresting and totally irrelevant stuff that happens in Life , The Universe and Everything</p>
<p>Questions, want to contact me please read my <a href="../faq/index/index.html">FAQ</a> and  <a href="../social/index/index.html">Social Media Policy</a></p>
<p>You can hire me! I work as a consultant for <a href="http://www.inuits.eu/">Inuits.eu</a></p>
</div>
</div>

  </div>

<div id="main">
  <div id="breadcrumb"><div class="breadcrumb"><a href="../index/index.html">Home</a> &#8594; <a href="../blog/index.html">Blogs</a> &#8594; <a href="../blogs/kris-buytaert/index.html">Kris Buytaert&#039;s blog</a></div></div>
  <h2 id="title">The 4158 second catalog run.</h2>
<div class="content">
<div id="node-1040" class="node  blog">
<div class="content"><p>Two of my tweets , sorry dents, earlier today caused some people to ask me what on earth I was doing :)</p>
<p><cite>You don't exist, go away! </cite></p>
<p>Was the first one, indeed .. it was a long time since I had actually seen that one..  this actually happens when you delete the user you are logged in with on a host, when the host notices you don't exist anymore it will tell you.</p>
<p>Now that is exactly what happend ..  We were busy reordening the uid's on some hosts ,  so I modified the puppet config for that host and changed the uid values,   a couple of minutes later I was told that I don't exist ..</p>
<p>The last time I saw that , was about 10 years ago when I was trying to fool some collegues :)</p>
<p>Now the second tweet that tracked some people's attention was the one about a very lengthy catalog run</p>
<p><div class="geshifilter"><pre class="text geshifilter-text" style="font-family:monospace;"><ol><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">Apr 20 05:12:42 sipx-a puppet-agent[22384]: Finished catalog run in 4158.09 seconds</div></li></ol></pre></div><br />
Indeed, a puppet catalog run of about 69 minutes, yes thats 1 hour and 9 minutes ..</p>
<p>The reason for this lengthy catalog run was the above uid reordering , combined with<br />
<div class="geshifilter"><pre class="text geshifilter-text" style="font-family:monospace;"><ol><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">       &quot;/var/sipxdata/&quot;:</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">                        owner =&gt; &quot;sipxchange&quot;, group =&gt; &quot;sipxchange&quot;,</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">                        recurse =&gt; true,</div></li><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">                        ensure =&gt; directory;</div></li></ol></pre></div></p>
<p>And about 5K files in that directory ..   apparently recurse doesn't translate to chown -R yet :)</p>
</div>
  <div class="meta">
   <div class="submitted">Submitted by Kris Buytaert on Wed, 04/20/2011 - 22:36</div>
     <div class="taxonomy">Tags: <ul class="links inline"><li class="taxonomy_term_775 first"><a href="../taxonomy/term/775/index.html" rel="tag" title="">automation</a></li>
<li class="taxonomy_term_439"><a href="../taxonomy/term/439/index.html" rel="tag" title="">puppet</a></li>
<li class="taxonomy_term_1450"><a href="../category/sipx/index.html" rel="tag" title="">sipx</a></li>
<li class="taxonomy_term_1449 last"><a href="../category/uid/index.html" rel="tag" title="">uid</a></li>
</ul></div>
     <div class="links">&raquo; <ul class="links inline"><li class="blog_usernames_blog first last"><a href="../blogs/kris-buytaert/index.html" title="Read Kris Buytaert&#039;s latest blog entries.">Kris Buytaert&#039;s blog</a></li>
</ul></div>
  </div>
</div>
<div id="comments">
  <h2>Comments</h2>
  <a id="comment-4308"></a>
<div id="comment-1" class="comment comment-by-anonymous clear-block">
  <div class="picture">
  <img src="http://www.gravatar.com/avatar/ef14b7b705e5580cb42d78f0a7fa9238.jpg?d=http%3A%2F%2F127.0.0.1%3A8080%2Fblog%2Fsites%2Fall%2Fmodules%2Fgravatar%2Favatar.png&amp;s=85&amp;r=G" alt="duritong&#039;s picture" title="duritong&#039;s picture"  /></div>
<h3>
    <a class="id" href="#comment-4308">#1</a>
    <span class="author"><span class="anonymous" title="not verified">duritong</span></span>  : <span class="title"><a href="index.html#comment-4308" class="active">recursive management of large directories is tricky</a></span>
  </h3>
  <div class="content"><p>There are some issues with managing a large folder hierarchy in puppet.</p>
<p>First, update to 2.6.x, as some improvements (memory and speed) were introduced in 2.6.x while managing large folder hierarchies. But actually, I would bet that you are already on 2.6.x?! ;)</p>
<p>(Regarding the next part I'm not sure if things changed recently or are still the same as I describe them. At least the situation was like that when I dealt with these problems...)</p>
<p>Second, puppet has the nice feature that it also knows (and records!) the checksum of each file managed in this directory. This means that puppet will compute for each file its md5sum (uff...) and also record it in its state.yml. You can turn that off by setting the checksum param to 'none'. This should actually already speed up things a lot.</p>
<p>And third, puppet will create for each file a resource object, so it can actually manage it. And this part is the trickiest part: How could we avoid that? As you mentioned puppet does not (yet) translate that to a chown -R and I doubt it will ever do that. For the simple reason that it is actually the idea of puppet to have for each file in this directory a resource object.</p>
<p>So how can we make that quicker, then? By translating the statement ourself to chown -R.</p>
<p>The simple exec statement:</p>
<p><div class="geshifilter"><pre class="text geshifilter-text" style="font-family:monospace;"><ol><li style="font-family: monospace; font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal">exec{'chown -R sipxchange:sipxchange /var/sipxdata': }</div></li></ol></pre></div></p>
<p>is quite obvious. We could combine it with a find statement that looks for files/directories not yet owned, by sipxchange:sipxchange and only run the chown if we find anything. But if you are mainly interested in speed then the above is much faster. Additionally, you could set loglevel to info so it does not poison your logs (and dashboard?) with a change each time puppet runs.</p>
<p>However, the disadvantage of this speedup is that puppet is not anymore (internally) dealing with a resource for each file and you are actually circumventing the puppet paradigm that a resource is only managed once. Also you are loosing the idempotent puppet runs. So you will need to remember that everything in this directory is managed specially and that if you are introducing any other resources in this directory, that are managed in another place, you will need to sync these two statements. Otherwise puppet will flip the ownership of a file always between runs, etc. Also you will loose some other capabilities such a notifications etc. Or at least they are less accurate.</p>
<p>So the main question that you need to answer in such a situation is: Which trade off am I willing to pay? Speed or consistency. In my opinion both are a valuable answer to certain situations. So (sadly) it is sometimes actually worth to cross over puppet's clean resource model in favor of (much more) speed. :(</p>
<p>Oh, another idea that just pops up my mind is that in combination with setting the checksum to none, you could also give a special tag for that resource. And then after <a href="http://projects.puppetlabs.com/issues/1107" title="http://projects.puppetlabs.com/issues/1107" rel="nofollow">http://projects.puppetlabs.com/issues/1107</a> got some love you could normally run puppet by excluding that large folder hierarchy and only run it once a day, or once a week with everything. Another special case, but it wouldn't circumvent the internal puppet model and hence maybe worth thinking about it (and voting for the feature in the bugtracker... ;) ).</p>
</div>
        <br class="clear" />
    <div class="submitted">04/22/2011 - 13:13</div>
  </div>
</div>
</div>
</div>

</div>

<div id="footer" class="footer">
  No really .. everything is a funky DNS problem , you'll realise I`m right pretty soon !   
  <p class="credits">Powered by <a href="http://www.drupal.org/">Drupal</a> and the <a href="http://www.drupal.org/project/barlow">Barlow</a> theme by <a href="http://egonbianchet.net/">Egon Bianchet</a>.</p>
</div>

</div>

</body>

<!-- Mirrored from 127.0.0.1:8080/blog/4158-second-catalog-run by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 01 Sep 2017 19:44:48 GMT -->
</html>
